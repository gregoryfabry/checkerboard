<!doctype html>
<html>
<head>
<script src="../../build/out.js"></script>
<script>

  function ATM() {
    this.onInitialize = function() {};
    this.onUpdate = function(){};
    
    this.stm = new checkerboard.STM('ws://localhost:9999');
    this.stm.action('create-account')
      .onReceive(function() {
        if (typeof this.account === 'undefined')
          this.account = {'balance': 100};
      });
      
    this.stm.action('deposit')
      .onReceive(function(amount) {
        this.account.balance += amount;
      });
      
      
    this.stm.action('withdrawal')
      .onReceive(function(amount) {
        this.account.balance -= amount;
      });
      
    var that = this;
    this.stm.init(function(store) {
      store.sendAction('create-account');
      store.account.addObserver(function(newValue, oldValue) {
        this.onUpdate(newValue.balance);
      });
      
      that.deposit = function(amount) {
        store.sendAction('deposit', amount);
      }
      
      that.withdrawal = function(amount) {
        store.sendAction('withdrawal', amount);
      }
      
      that.onInitialize();
    });
  }
  
  function Bank() {
    this.onInitialize = function() {};
    this.onUpdate = function(){};
    
    this.stm = new checkerboard.STM('ws://localhost:9999');
    
    this.stm.action('create-account')
      .onReceive(function() {
        if (typeof this.account === 'undefined')
          this.account = {'balance': 100};
      });
    
    var that = this;
    this.stm.init(function(store) {
      store.sendAction('create-account');
      store.account.addObserver(function(newValue, oldValue) {
        that.onUpdate(newValue.balance);
      });
      
      that.onInitialize();
    });
  }
  
  var atm1 = new ATM();
  var atm2 = new ATM();
  var bank = new Bank();
</script>
</head>
<body>
<div class="panel">

</div>

</body>
</html>