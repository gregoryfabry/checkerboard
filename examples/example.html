<!DOCTYPE html>
<html>
<head>
  <script src="../checkerboard.js"></script>
  <script src="q.min.js"></script>
  <script src="interact-1.2.4.min.js"></script>
  <style type="text/css">
  html, body {background-color: #222222; overflow: hidden; height: 100%}
  #container {min-height: 100%}
  .snippet { text-align: center; max-width: 600px; position: absolute; display: inline-block; font-size: 16pt; padding: 30px; border: 1px black solid; border-radius: 10px; background-color: white; -webkit-touch-callout: none; -webkit-user-select: none; khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
  </style>
  <script>
    var snippets = ["The diets of the majority of people in this suburb include meat..", "The people of this suburb rely on the two available butcher shops for their meat needs.", "The people of this suburb rely on the public pumps for their water needs.", "The majority of the people of this suburb are poor. They are crowded into one or two bedroom apartments.", "The epidemic hit the suburb during a hot summer.", "During the day, the temperature ranged between 92F and 108F.", "Jennifer Johnson ate two slices of vegetarian pizza with a glass of water in a restaurant on Spring Street.", "Tony Jordan was the owner of the bakery at Coventry Market.", "Tom Slye, Alice Slye, and James Slye are the three children of Williams Slye, the owner of the butcher shop on Spring Street.", "Alex Satterfield was a successful lawyer and won most of his assigned cases.", "Before going home, Jennifer Johnson filled her water bottle from the public water pump on Coventry Market. As she filled her bottle, she told a neighbor \"the water of this pump is still the best in this city\"..", "When not in school, Tom Slye, Alice Slye, and James Slye accompanied their father to work and played soccer on the side walk on Spring Street..", "Tony Jordan bought a hamburger from the butcher shop on Johnson Street.", "It was a hot day, so Alex Satterfield drank lots of water after the meal before he left his aunt's apartment.", "Jennifer Johnson died after two days in the hospital at Marston Court Road.", "Alex Satterfield had tea, biscuits and sausages that his aunt bought from the butcher shop on Johnson Stree.", "Tony Jordan went back home, fried the burger and the fries and ate his meal as he watched TV.", "Alex Satterfield passed by the Police Station on Cops Street to collect some information on his new case.", "Tony Jordan bought one pound of potatoes from the super market on Johnson Street.", "The next morning Tony Jordan was found dead in his bed.", "Two hours prior to his death, Alex Satterfield stopped off to visit his aunt Matilda Wright"];

    var stm, ws = new WebSocket('ws://localhost:904/');
    ws.onopen = function() {
      stm = new SharedTransactionalMemory(ws);

      stm.onready = function() {
        stm.try(function(state) {
          if (!('snippets' in state)) {
            state('snippets', snippets.map(function(snippet, index) {
              return {'text': snippet, 'hold': false, 'x': 0, 'y': 0, 'z': index, 'scale': 1, 'angle': 0, 'identifier': index}
            }));
            state('lastZ', snippets.length);
          }
        }).then(function(state) {
          var element;
          state.snippets().forEach(function(snippet) {
            element = document.createElement('div');
            element.className = "interact snippet";
            element.setAttribute('data-identifier', snippet.identifier);
            updateElement(element, snippet);
            document.getElementById('container').appendChild(element);
          });
        }).done();
      }

      stm.onchange = function(state) {
        var el;
        for (var i = 0; i < state.snippets().length; i++)
          if ((el = document.getElementById('snippet-' + state.snippets[i]().identifier)) !== null)
            updateElement(el, state.snippets[i]());
      }

      stm.sync(25);
    }

    function updateElement(element, snippet) {
      element.innerText = snippet.text;
      element.style['z-index'] = snippet.z;
      element.id = 'snippet-' + snippet.identifier;

      element.style.webkitTransform =
      element.style.transform =
      'translate(' + snippet.x + 'px, ' + snippet.y + 'px) scale(' + snippet.scale + ') rotate(' + snippet.angle + 'deg)';
    };

    function getSnippet(state, target) {
      var identifier = parseInt(target.getAttribute('data-identifier'));
      var index = state.snippets.$$.data.map(function(s) {return s.identifier;}).indexOf(identifier);
      return state.snippets[index];
    }

    var onstart = function (event) {
      stm.try(function(state) {
        snippet = getSnippet(state, event.target);

        if (!snippet.hold()) {
          snippet.hold(stm.uuid());
        }
      });
    };

    var onmove = function (event) {
      stm.try(function(state) {
        snippet = getSnippet(state, event.target);

        if (snippet.hold() == stm.uuid())
        {
          snippet.x(snippet.x() + event.dx);
          snippet.y(snippet.y() + event.dy);

          var scale = snippet.scale() * (1 + (event.ds || 0));
          if (scale > 0.5 && scale < 2)
            snippet.scale(scale);
          snippet.angle(snippet.angle() + (1 * (event.da || 0)));
          snippet.z(state.lastZ() + 1);
          state.lastZ(state.lastZ() + 1);
          updateElement(event.target, snippet());
        }
      });
    };

    var onend = function(event) {
      stm.try(function(state) {
        snippet = getSnippet(state, event.target);

        if (snippet.hold() == stm.uuid())
          snippet.hold(false);
      });
    };

    interact('.interact')
      .draggable({
        inertia: true,
        restrict: {restriction: '#container'},
        onstart: onstart,
        onmove: onmove,
        onend: onend
      })
      .gesturable({
        onstart: onstart,
        onmove: onmove,
        onend: onend
      });
  </script>
</head>
<body>
<div id="container">&nbsp;</div>
</body>
</html>
